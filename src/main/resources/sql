WITH RECURSIVE CommentTree AS (
    SELECT idx, title, article, email, writer, createAt, isNotice, isPrivate, boardView, replyIdx, 0 AS level
    FROM stn_boards
    WHERE replyIdx IS NULL AND isNotice = 0
    UNION ALL
    SELECT b.idx, b.title, b.article, b.email, b.writer, b.createAt, b.isNotice, b.isPrivate, b.boardView, b.replyIdx, ct.level + 1
    FROM stn_boards b
    INNER JOIN CommentTree ct ON b.replyIdx = ct.idx
)
SELECT
	board.idx
	, board.title
	, board.article
	, board.email
	, (SELECT COUNT(*) FROM stn_files f WHERE board.idx = f.boardIdx) AS fileCount
	, board.writer
	, board.createAt
	, board.isNotice
	, board.isPrivate
	, IF(DATE_FORMAT(board.createAt, '%Y-%m-%d') = DATE_FORMAT(NOW(), '%Y-%m-%d'), 1, 0) AS isNewData
	, boardView
	, (SELECT COUNT(*) FROM stn_comments c WHERE board.idx = c.boardIdx) AS commentCount
FROM
	CommentTree board
ORDER BY
    COALESCE(board.replyIdx, board.idx) DESC
